#!/usr/bin/make
# @configure_input@

depsdir = @PWD@/deps
toolsdir = @PWD@/tools
workdir = @WORKDIR@
datdir = @PWD@/data
resultsdir = @PWD@/results

WGET = @WGET@

SPKNAMES = bet eli eva jan mar ona pau pep pol teo uri

# upc_ca_base:
upc_ca_base_File = upc_ca_base-3.0.5-src.tgz
upc_ca_base_MD5 = 1f62a506a1c633e0e6dbef81e223bb27
upc_ca_base_URL = https://github.com/FestCat/festival-ca/archive/upstream/3.0.5.tar.gz

.PHONY: all lang_ca ca_ona upc_ca_base %.spk

all: lang_ca ca_ona


lang_ca: upc_ca_base

upc_ca_base: download_upc_ca_base
	mkdir -p upc_ca_base && \
	tar xzf $(upc_ca_base_File) -C upc_ca_base --strip-components 1 && \
	cd upc_ca_base && \
	./configure --enable-onlyinstall --enable-festivalpath=$(toolsdir)/festival/bin && \
	$(MAKE) install


download_upc_ca_base:
	echo $@ && \
	echo $(subst download_,,$@) && \
	echo "$($(subst download_,,$@)_MD5)  $($(subst download_,,$@)_File)" | md5sum -c --status && echo "$(subst download_,,$@) already downloaded" || \
	( rm -f $($(subst download_,,$@)_File) && \
	$(WGET) --output-document=$($(subst download_,,$@)_File) $($(subst download_,,$@)_URL) )

%.spk: %.download lang_ca
	if test ! -f $(workdir)/$*/configure.ac  -o  ! -d $(workdir)/$*/data/utts/  -o   ! -f $(workdir)/$*/data/utts/*.utt  ; then \
		rm -rf $(workdir)/$* && mkdir -p $(workdir)/$* && \
		cp -r $(datdir)/ca/template/* $(workdir)/$*/ && \
		sed s/SPEAKER/$(subst ca_,,$*)/g < $(workdir)/$*/package/festvox/upc_ca_SPEAKER_hts.scm > $(workdir)/$*/package/festvox/upc_ca_$(subst ca_,,$*)_hts.scm && \
		rm $(workdir)/$*/package/festvox/upc_ca_SPEAKER_hts.scm && \
		mkdir -p $(workdir)/$*/data/raw $(workdir)/$*/data/utts && \
		if test  ! -d $(datdir)/ca/$*/upc_$*_raw/   -o   ! -f $(datdir)/ca/$*/upc_$*_raw/*.raw  ; then \
			tar xjf $(datdir)/ca/$*/upc_$*_raw.tar.bz2 -C $(datdir)/ca/$*; \
		fi && \
		mv $(datdir)/ca/$*/upc_$*_raw/recordings/*.raw $(workdir)/$*/data/raw && \
		$(RM) -rf $(datdir)/ca/$*/upc_$*_raw/ && \
		tar xjf $(datdir)/ca/$*/upc_$*_utt.tar.bz2 -C $(datdir)/ca/$*  && \
		mv $(datdir)/ca/$*/upc_$*_utt/utt/*.utt $(workdir)/$*/data/utts && \
		$(RM) -rf $(datdir)/ca/$*/upc_$*_utt/; \
	fi; \
	cd $(workdir)/$* && \
	. $(datdir)/ca/speakerprop.sh $(subst ca_,,$*) && \
	./configure --with-fest-search-path=$(toolsdir)/festival/examples \
		    --with-sptk-search-path=$(toolsdir)/bin \
	            --with-hts-search-path=$(toolsdir)/bin  \
	            --with-hts-engine-search-path=$(toolsdir)/bin \
	            SPEAKER=$(subst ca_,,$*) && \
	$(MAKE) data && \
	$(MAKE) voice && \
	(cd $(workdir)/$*/upc_$*_hts && autoconf) && \
	$(MAKE) upc_$*_hts.tgz && \
	mkdir -p $(resultsdir) && \
	cp $(workdir)/$*/upc_$*_hts.tgz $(resultsdir)


%.download: %.downutt %.downraw
	echo ""

%.downutt:
	mkdir -p "$*" && cd "$*" && \
	[ -f "upc_$*_utt.tar.bz2" ] && echo "$* (utts) already downloaded" || \
	$(WGET) --output-document=upc_$*_utt.tar.bz2 http://festcat.talp.cat/download/data/upc_$*_utt-1.0.tar.bz2 


%.downraw:
	mkdir -p "$*" && cd "$*" && \
	[ -f "upc_$*_raw.tar.bz2" ] && echo "$* (raw) already downloaded" || \
	$(WGET) --output-document=upc_$*_raw.tar.bz2 http://festcat.talp.cat/download/data/upc_$*_raw-1.0.tar.bz2



